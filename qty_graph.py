import pandas as pd
import matplotlib.pyplot as plt
import io

# 로그 텍스트 입력 (그대로 복사/붙여넣기)
log_text = """매매일자	주문번호	매매구분	종목코드	종목명	수량	체결가격
09/02	7715	매수	004800	효성	2	84,600
09/02	6559	매도	004800	효성	1	85,600
09/02	6104	매수	004800	효성	1	85,300
09/02	5763	매도	004800	효성	1	85,500
09/02	5343	매수	004800	효성	1	85,400
09/02	5187	매도	004800	효성	1	85,600
09/02	4929	매수	004800	효성	1	85,400
09/02	2836	매수	004800	효성	116	85,998
09/03	6809	매도	025860	남해화학	2	6,910
09/03	6682	매수	086980	쇼박스	7	2,685
09/03	6350	매수	025860	남해화학	2	6,900
09/03	6005	매수	012450	한화에어로스페이스	10	936,000
09/03	6004	매수	086980	쇼박스	3,717	2,688
09/03	6002	매수	025860	남해화학	1,447	6,908
09/03	5991	매도	004800	효성	117	84,100
09/02	13327	매도	004800	효성	1	85,000
09/02	11023	매수	004800	효성	1	84,600
09/02	8801	매도	004800	효성	1	84,800
09/03	9006	매도	025860	남해화학	2	6,930
09/03	8469	매수	025860	남해화학	2	6,900
09/03	7856	매수	025860	남해화학	2	6,910
09/03	7649	매도	086980	쇼박스	7	2,690
09/03	7648	매도	025860	남해화학	2	6,920
09/03	7483	매수	086980	쇼박스	7	2,685
09/03	7482	매도	025860	남해화학	2	6,910
09/03	7191	매도	086980	쇼박스	7	2,690
09/03	7190	매도	025860	남해화학	2	6,900
09/03	6983	매수	025860	남해화학	4	6,890
09/03	9006	매도	025860	남해화학	2	6,930
09/03	8469	매수	025860	남해화학	2	6,900
09/03	7856	매수	025860	남해화학	2	6,910
09/03	7649	매도	086980	쇼박스	7	2,690
09/03	7648	매도	025860	남해화학	2	6,920
09/03	7483	매수	086980	쇼박스	7	2,685
09/03	7482	매도	025860	남해화학	2	6,910
09/03	7191	매도	086980	쇼박스	7	2,690
09/03	7190	매도	025860	남해화학	2	6,900
09/03	6983	매수	025860	남해화학	4	6,890
09/04	5900	매수	003570	SNT다이내믹스	1	60,200
09/04	5089	매수	003570	SNT다이내믹스	1	60,600
09/04	5088	매도	086980	쇼박스	7	2,720
09/04	4880	매도	086980	쇼박스	7	2,715
09/04	4775	매수	003570	SNT다이내믹스	1	60,900
09/04	4773	매수	086980	쇼박스	7	2,710
09/04	4617	매수	003570	SNT다이내믹스	163	61,200
09/04	4616	매도	086980	쇼박스	41	2,715
09/04	4612	매도	025860	남해화학	49	6,940
09/03	12348	매도	086980	쇼박스	7	2,685
09/04	8683	매도	086980	쇼박스	7	2,725
09/04	8444	매수	086980	쇼박스	7	2,720
09/04	8227	매수	003570	SNT다이내믹스	1	60,200
09/04	8226	매도	086980	쇼박스	7	2,725
09/04	8091	매도	003570	SNT다이내믹스	2	60,300
09/04	7345	매수	003570	SNT다이내믹스	1	59,800
09/04	7342	매수	086980	쇼박스	7	2,720
09/04	6716	매도	086980	쇼박스	7	2,725
09/04	6509	매수	086980	쇼박스	7	2,720
09/04	6282	매도	086980	쇼박스	7	2,725
"""

# 1) 데이터프레임 변환
df = pd.read_csv(io.StringIO(log_text.strip()), sep='\t')
df['수량'] = df['수량'].astype(str).str.replace(',', '').astype(int)
df['날짜'] = '2025-' + df['매매일자'].str.replace('/', '-')
df['날짜'] = pd.to_datetime(df['날짜'])

# 2) 종목별, 일자별로 수량 변화 계산
df['수량변동'] = df.apply(lambda x: x['수량'] if x['매매구분'] == '매수' else -x['수량'], axis=1)
date_range = pd.date_range(df['날짜'].min(), df['날짜'].max())
종목리스트 = df['종목명'].unique()

잔고_시계열 = {stock:[] for stock in 종목리스트}
잔고_현황 = {stock:0 for stock in 종목리스트}

잔고_전체 = {'날짜': []}
for stock in 종목리스트:
    잔고_전체[stock] = []

for date in date_range:
    당일 = df[df['날짜'] == date]
    for _, row in 당일.iterrows():
        잔고_현황[row['종목명']] += row['수량변동']
    잔고_전체['날짜'].append(date)
    for stock in 종목리스트:
        잔고_전체[stock].append(잔고_현황[stock])

잔고_df = pd.DataFrame(잔고_전체)
잔고_df.set_index('날짜', inplace=True)

# 3) 그래프
import matplotlib.font_manager as fm
plt.rcParams['font.family'] = 'Malgun Gothic'
plt.figure(figsize=(14,7))
for stock in 종목리스트:
    plt.plot(잔고_df.index, 잔고_df[stock], marker='o', label=stock)
plt.xlabel('일자')
plt.ylabel('보유수량')
plt.title('종목별 보유수량(잔고) 변화')
plt.legend()
plt.grid()
plt.tight_layout()
plt.show()
