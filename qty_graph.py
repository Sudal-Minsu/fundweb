import pandas as pd
import matplotlib.pyplot as plt
import io

# 로그 텍스트 입력 (그대로 복사/붙여넣기)
log_text = """매매일자	주문번호	매매구분	종목코드	종목명	수량	체결가격
08/06	3179	매수	023960	에쓰씨엔지니어링	3,941	1,254
08/06	3178	매수	000220	유유제약	2,257	4,414
08/05	6165	매수	041960	코미팜	4	5,290
08/05	5763	매도	041960	코미팜	15	5,300
08/05	5630	매수	041960	코미팜	4	5,250
08/05	5406	매도	041960	코미팜	4	5,270
08/05	5267	매수	041960	코미팜	8	5,250
08/05	5161	매도	041960	코미팜	4	5,280
08/05	4907	매도	041960	코미팜	4	5,270
08/05	4797	매도	041960	코미팜	7	5,260
08/05	4663	매수	041960	코미팜	11	5,240
08/05	4594	매도	041960	코미팜	11	5,270
08/05	4523	매도	041960	코미팜	7	5,240
08/05	4379	매수	041960	코미팜	7	5,220
08/05	4283	매수	041960	코미팜	11	5,240
08/05	4226	매수	041960	코미팜	4	5,250
08/05	4025	매수	041960	코미팜	7	5,260
08/05	3467	매수	012450	한화에어로스페이스	10	966,900
08/05	3462	매수	041960	코미팜	1,886	5,271
08/04	5525	매수	078340	컴투스	1	38,400
08/04	5437	매도	004800	효성	1	83,600
08/04	5340	매도	078340	컴투스	1	38,500
08/04	5282	매수	078340	컴투스	1	38,450
08/04	5131	매수	004800	효성	1	83,300
08/04	4998	매수	004800	효성	1	83,500
08/04	4831	매도	078340	컴투스	1	38,550
08/04	4731	매수	078340	컴투스	1	38,400
08/04	4635	매수	078340	컴투스	1	38,500
08/04	4391	매수	078340	컴투스	1	38,600
08/04	4280	매도	078340	컴투스	2	38,650
08/04	4135	매수	078340	컴투스	1	38,450
08/04	3776	매도	078340	컴투스	2	38,675
08/04	3605	매도	078340	컴투스	1	38,300
08/04	3502	매수	004800	효성	1	84,400
08/04	3409	매도	004800	효성	1	84,900
08/04	3257	매수	004800	효성	1	84,500
08/04	2963	매도	004800	효성	1	84,900
08/04	2797	매수	078340	컴투스	1	38,050
08/04	2490	매수	003230	삼양식품	7	1,403,857
08/04	2488	매수	004800	효성	118	84,300
08/04	2487	매수	078340	컴투스	261	38,270
07/31	7467	매수	006360	GS건설	2	19,350
07/31	7466	매도	000210	DL	1	50,500
07/31	7352	매수	000210	DL	1	50,200
07/31	7155	매도	006360	GS건설	2	19,510
07/31	7084	매도	006360	GS건설	2	19,460
07/31	7082	매도	000210	DL	1	50,300
07/31	7002	매도	000210	DL	1	50,200
07/31	6886	매수	006360	GS건설	1	19,350
07/31	6885	매수	000210	DL	1	50,000
07/31	6747	매도	006360	GS건설	1	19,440
07/31	6385	매수	006360	GS건설	516	19,350
07/31	6381	매수	000210	DL	199	50,100"""

# 1) 데이터프레임 변환
df = pd.read_csv(io.StringIO(log_text.strip()), sep='\t')
df['수량'] = df['수량'].astype(str).str.replace(',', '').astype(int)
df['날짜'] = '2025-' + df['매매일자'].str.replace('/', '-')
df['날짜'] = pd.to_datetime(df['날짜'])

# 2) 종목별, 일자별로 수량 변화 계산
df['수량변동'] = df.apply(lambda x: x['수량'] if x['매매구분'] == '매수' else -x['수량'], axis=1)
date_range = pd.date_range(df['날짜'].min(), df['날짜'].max())
종목리스트 = df['종목명'].unique()

잔고_시계열 = {stock:[] for stock in 종목리스트}
잔고_현황 = {stock:0 for stock in 종목리스트}

잔고_전체 = {'날짜': []}
for stock in 종목리스트:
    잔고_전체[stock] = []

for date in date_range:
    당일 = df[df['날짜'] == date]
    for _, row in 당일.iterrows():
        잔고_현황[row['종목명']] += row['수량변동']
    잔고_전체['날짜'].append(date)
    for stock in 종목리스트:
        잔고_전체[stock].append(잔고_현황[stock])

잔고_df = pd.DataFrame(잔고_전체)
잔고_df.set_index('날짜', inplace=True)

# 3) 그래프
import matplotlib.font_manager as fm
plt.rcParams['font.family'] = 'Malgun Gothic'
plt.figure(figsize=(14,7))
for stock in 종목리스트:
    plt.plot(잔고_df.index, 잔고_df[stock], marker='o', label=stock)
plt.xlabel('일자')
plt.ylabel('보유수량')
plt.title('종목별 보유수량(잔고) 변화')
plt.legend()
plt.grid()
plt.tight_layout()
plt.show()
