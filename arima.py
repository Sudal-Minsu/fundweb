# -*- coding: utf-8 -*-
"""Untitled11.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1QLSXmSWQsdhLm2MhU3IbTx9e5bS1L_m8

ARIMA ëª¨ë¸ ë‹¨ì¼ ì‚¬ìš©
"""

import yfinance as yf
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from statsmodels.tsa.arima.model import ARIMA
from datetime import datetime, timedelta

# ì£¼ì‹ ë°ì´í„° ë‹¤ìš´ë¡œë“œ
ticker = "AAPL"  # ì˜ˆì œ: ì• í”Œ ì£¼ì‹
start_date = "2020-01-01"
end_date = "2024-03-20"

data = yf.download(ticker, start=start_date, end=end_date)
data = data[['Close']]  # ì¢…ê°€ë§Œ ì‚¬ìš©

# ARIMA ëª¨ë¸ ì„¤ì • ë° í›ˆë ¨
p, d, q = 5, 1, 0  # ARIMA(5,1,0) ì˜ˆì œ, ìµœì ì˜ ê°’ì€ íŠœë‹ í•„ìš”
model = ARIMA(data['Close'], order=(p, d, q))
model_fit = model.fit()

# ë¯¸ë˜ ì˜ˆì¸¡ (30ì¼)
future_days = 30
future_dates = [data.index[-1] + timedelta(days=i) for i in range(1, future_days + 1)]
forecast = model_fit.forecast(steps=future_days)

# ì‹œê°í™”
plt.figure(figsize=(12, 6))
plt.plot(data.index, data['Close'], label="Actual Price")
plt.plot(future_dates, forecast, label="Predicted Price", linestyle='dashed', color='red')
plt.xlabel("Date")
plt.ylabel("Stock Price")
plt.title(f"{ticker} Stock Price Prediction (ARIMA)")
plt.legend()
plt.show()

"""ARIMA ëª¨ë¸ + GARCH ëª¨ë¸"""

#ìµœì´ˆ ì‹¤í–‰ì‹œ ì´ ì½”ë“œ í•„ìš”
!pip install yfinance statsmodels arch matplotlib numpy pandas

import yfinance as yf
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from statsmodels.tsa.arima.model import ARIMA
from arch import arch_model
from datetime import timedelta

# ğŸ“Œ ì£¼ì‹ ë°ì´í„° ë‹¤ìš´ë¡œë“œ
ticker = "AAPL"  # ì˜ˆì œ: ì• í”Œ ì£¼ì‹
start_date = "2020-01-01"
end_date = "2024-03-20"

data = yf.download(ticker, start=start_date, end=end_date)
data = data[['Close']]  # ì¢…ê°€ë§Œ ì‚¬ìš©
returns = 100 * data['Close'].pct_change().dropna()  # ë¡œê·¸ ìˆ˜ìµë¥  ê³„ì‚°

# ğŸ“Œ ARIMA ëª¨ë¸ ì ìš© (í‰ê·  ìˆ˜ì¤€ ì˜ˆì¸¡)
p, d, q = 5, 1, 0  # í•˜ì´í¼íŒŒë¼ë¯¸í„°ëŠ” ì¡°ì • ê°€ëŠ¥
arima_model = ARIMA(data['Close'], order=(p, d, q))
arima_fit = arima_model.fit()

# ğŸ“Œ GARCH ëª¨ë¸ ì ìš© (ë³€ë™ì„± ì˜ˆì¸¡)
garch_model = arch_model(returns, vol='Garch', p=1, q=1)
garch_fit = garch_model.fit(disp='off')

# ğŸ“Œ ë¯¸ë˜ ì˜ˆì¸¡ (30ì¼)
future_days = 30
future_dates = [data.index[-1] + timedelta(days=i) for i in range(1, future_days + 1)]

# ARIMA ì˜ˆì¸¡ (í‰ê· ê°’ ì˜ˆì¸¡)
arima_forecast = arima_fit.forecast(steps=future_days)

# ğŸ“Œ GARCH ì˜ˆì¸¡ ìˆ˜ì •
garch_forecast = garch_fit.forecast(horizon=future_days, reindex=False)  # reindex=False ì¶”ê°€
volatility_forecast = np.sqrt(garch_forecast.variance.values[-1])  # ë³€ë™ì„± ì˜ˆì¸¡ ìˆ˜ì •

# ARIMA-GARCH ì¡°í•©
np.random.seed(42)
simulated_returns = np.random.normal(loc=0, scale=volatility_forecast)
predicted_prices = arima_forecast.values + simulated_returns  # ë³€ë™ì„±ì„ ë°˜ì˜í•œ ì˜ˆì¸¡ê°’

# ğŸ“Œ ì‹œê°í™”
plt.figure(figsize=(12, 6))
plt.plot(data.index, data['Close'], label="Actual Price", color='blue')
plt.plot(future_dates, arima_forecast, label="ARIMA Predicted Price", linestyle='dashed', color='red')
plt.plot(future_dates, predicted_prices, label="ARIMA-GARCH Predicted Price", linestyle='dotted', color='green')
plt.xlabel("Date")
plt.ylabel("Stock Price")
plt.title(f"{ticker} Stock Price Prediction (ARIMA-GARCH)")
plt.legend()
plt.show()

"""ARIMA + LSTM"""

#ìµœì´ˆ ì‹¤í–‰ ì‹œ í•„ìš”
!pip install yfinance numpy pandas matplotlib tensorflow keras statsmodels scikit-learn

import yfinance as yf
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from statsmodels.tsa.arima.model import ARIMA
from sklearn.preprocessing import MinMaxScaler
import tensorflow as tf
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import LSTM, Dense
from datetime import timedelta

# ğŸ“Œ ì£¼ì‹ ë°ì´í„° ë‹¤ìš´ë¡œë“œ
ticker = "AAPL"  # ì˜ˆì œ: ì• í”Œ ì£¼ì‹
start_date = "2020-01-01"
end_date = "2024-03-20"

data = yf.download(ticker, start=start_date, end=end_date)
data = data[['Close']]  # ì¢…ê°€ë§Œ ì‚¬ìš©

# ğŸ“Œ 1ï¸âƒ£ ARIMA ëª¨ë¸ ì ìš© (ì¥ê¸° íŠ¸ë Œë“œ ì˜ˆì¸¡)
p, d, q = 5, 1, 0  # ARIMA í•˜ì´í¼íŒŒë¼ë¯¸í„° (íŠœë‹ ê°€ëŠ¥)
arima_model = ARIMA(data['Close'], order=(p, d, q))
arima_fit = arima_model.fit()
arima_forecast = arima_fit.forecast(steps=30)  # 30ì¼ ì˜ˆì¸¡

# ğŸ“Œ ë°ì´í„° ì •ê·œí™” (LSTM í•™ìŠµì„ ìœ„í•´)
scaler = MinMaxScaler(feature_range=(0, 1))
scaled_data = scaler.fit_transform(data)

# ğŸ“Œ LSTM í•™ìŠµ ë°ì´í„° ì¤€ë¹„
def create_dataset(dataset, look_back=60):
    X, Y = [], []
    for i in range(len(dataset) - look_back):
        X.append(dataset[i:(i + look_back), 0])
        Y.append(dataset[i + look_back, 0])
    return np.array(X), np.array(Y)

look_back = 60  # ê³¼ê±° 60ì¼ ë°ì´í„° ê¸°ë°˜ ì˜ˆì¸¡
X, Y = create_dataset(scaled_data, look_back)

# ğŸ“Œ ë°ì´í„° ì°¨ì› ë³€í™˜ (LSTM ì…ë ¥ í˜•ì‹: [samples, time steps, features])
X = np.reshape(X, (X.shape[0], X.shape[1], 1))

# ğŸ“Œ 2ï¸âƒ£ LSTM ëª¨ë¸ ìƒì„± ë° í•™ìŠµ (ë¹„ì„ í˜• íŒ¨í„´ ì˜ˆì¸¡)
model = Sequential([
    LSTM(units=50, return_sequences=True, input_shape=(X.shape[1], 1)),
    LSTM(units=50, return_sequences=False),
    Dense(units=25),
    Dense(units=1)
])

model.compile(optimizer='adam', loss='mean_squared_error')
model.fit(X, Y, epochs=20, batch_size=16, verbose=1)

# ğŸ“Œ ë¯¸ë˜ ë°ì´í„° ì˜ˆì¸¡ (30ì¼)
future_data = scaled_data[-look_back:].reshape(1, look_back, 1)  # ê°€ì¥ ìµœê·¼ ë°ì´í„° ì‚¬ìš©
lstm_forecast = []

for _ in range(30):
    pred = model.predict(future_data)
    lstm_forecast.append(pred[0, 0])
    new_input = np.append(future_data[0, 1:], pred).reshape(1, look_back, 1)
    future_data = new_input  # ìƒˆë¡œìš´ ë°ì´í„° ì¶”ê°€

# ğŸ“Œ ì •ê·œí™” í•´ì œ (ì›ë˜ ì£¼ê°€ ë²”ìœ„ë¡œ ë³€í™˜)
lstm_forecast = scaler.inverse_transform(np.array(lstm_forecast).reshape(-1, 1)).flatten()

# ğŸ“Œ 3ï¸âƒ£ ARIMA + LSTM ê²°í•© (ë‹¨ìˆœ í‰ê· )
final_forecast = (arima_forecast.values + lstm_forecast) / 2

# ğŸ“Œ ë¯¸ë˜ ë‚ ì§œ ìƒì„±
future_dates = [data.index[-1] + timedelta(days=i) for i in range(1, 31)]

# ğŸ“Œ ì‹œê°í™”
plt.figure(figsize=(12, 6))
plt.plot(data.index, data['Close'], label="Actual Price", color='blue')
plt.plot(future_dates, arima_forecast, label="ARIMA Forecast", linestyle='dashed', color='red')
plt.plot(future_dates, lstm_forecast, label="LSTM Forecast", linestyle='dotted', color='green')
plt.plot(future_dates, final_forecast, label="Hybrid Forecast (ARIMA+LSTM)", linestyle='dashdot', color='purple')
plt.xlabel("Date")
plt.ylabel("Stock Price")
plt.title(f"{ticker} Stock Price Prediction (ARIMA + LSTM)")
plt.legend()
plt.show()